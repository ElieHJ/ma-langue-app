<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polyglot Dialogue Coach</title>
    <style>
        :root { --primary: #4A90E2; --success: #4caf50; --accent: #ff9800; --bg: #f4f7f9; --text: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 15px; margin: 0; color: var(--text); }
        .container { width: 100%; max-width: 500px; background: white; padding: 25px; border-radius: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); text-align: center; }
        
        .scenario-box { background: #f0f7ff; padding: 12px; border-radius: 15px; font-size: 0.85rem; color: var(--primary); font-weight: bold; margin-bottom: 15px; border-left: 5px solid var(--primary); }
        
        .chat-area { display: flex; flex-direction: column; gap: 15px; margin: 20px 0; min-height: 250px; }
        .bubble { padding: 15px 20px; border-radius: 20px; max-width: 85%; font-size: 1.1rem; line-height: 1.4; position: relative; }
        .bubble.bot { background: #eee; align-self: flex-start; border-bottom-left-radius: 5px; color: #333; text-align: left; }
        .bubble.user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 5px; text-align: right; display: none; }
        
        .rtl { direction: rtl; font-family: 'Arial', sans-serif; font-size: 1.4rem !important; }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        button { padding: 16px; border: none; border-radius: 15px; cursor: pointer; font-weight: 700; transition: 0.2s; }
        .btn-mic { background: var(--success); color: white; grid-column: span 2; font-size: 1.1rem; }
        .btn-next { background: var(--primary); color: white; grid-column: span 2; }
        .btn-listen { background: var(--accent); color: white; }
        .btn-hint { background: #95a5a6; color: white; }
        
        #status { font-size: 0.8rem; color: #bdc3c7; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div class="scenario-box" id="scenarioTag">MODE DIALOGUE</div>
    
    <select id="langSelect" onchange="loadFromCloud()">
        <option value="en-US">Anglais ğŸ‡ºğŸ‡¸</option>
        <option value="he-IL">HÃ©breu ğŸ‡®ğŸ‡±</option>
        <option value="es-ES">Espagnol ğŸ‡ªğŸ‡¸</option>
    </select>

    <div class="chat-area">
        <div class="bubble bot" id="botBubble">Appuie sur "Lancer un dialogue" pour commencer !</div>
        <div class="bubble user" id="userBubble">...</div>
    </div>

    <div class="controls">
        <button class="btn-mic" onclick="ecouterUtilisateur()">ğŸ¤ RÃ‰PONDRE</button>
        <button class="btn-listen" onclick="rejouerQuestion()">ğŸ”Š RÃ‰Ã‰COUTER</button>
        <button class="btn-hint" onclick="afficherAide()">ğŸ’¡ AIDE</button>
        <button class="btn-next" onclick="prochainDialogue()">LANCER UN DIALOGUE â”</button>
    </div>

    <p id="status">Cloud connectÃ©</p>
    <button style="font-size: 10px; margin-top:20px; background:none; border:none; color:#ccc;" onclick="seedDialogues()">Initialiser les dialogues types</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB2v6Biqc9DjryoFJa1q1ezNFFeoo0QJrg",
    authDomain: "mon-app-langue.firebaseapp.com",
    projectId: "mon-app-langue",
    storageBucket: "mon-app-langue.firebasestorage.app",
    messagingSenderId: "664705865852",
    appId: "1:664705865852:web:1b8512b74bdcef753651f9"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.dialogues = [];
  window.currentIdx = -1;

  window.loadFromCloud = async function() {
    const lang = document.getElementById('langSelect').value;
    const q = query(collection(db, "dialogues"));
    const snap = await getDocs(q);
    window.dialogues = [];
    snap.forEach(doc => {
        if(doc.data().lang === lang) window.dialogues.push(doc.data());
    });
    document.getElementById('status').innerText = "Dialogues chargÃ©s : " + window.dialogues.length;
  };

  window.seedDialogues = async function() {
    const starter = [
        { lang: "en-US", question: "Hello! What is your name?", answer: "my name is", scenario: "RENCONTRE", hint: "RÃ©ponds : 'My name is [Ton nom]'" },
        { lang: "en-US", question: "How can I help you today?", answer: "i would like", scenario: "AU MAGASIN", hint: "RÃ©ponds : 'I would like a coffee'" },
        { lang: "he-IL", question: "××” × ×©××¢?", answer: "×”×›×œ ×˜×•×‘", scenario: "SALUTATIONS", hint: "RÃ©ponds : 'Hakol tov' (Tout va bien)" },
        { lang: "he-IL", question: "××™×¤×” ××ª×” ×’×¨?", answer: "×× ×™ ×’×¨ ×‘", scenario: "GEOGRAPHIE", hint: "RÃ©ponds : 'Ani gar be...' (J'habite Ã ...)" }
    ];
    for (const d of starter) { await addDoc(collection(db, "dialogues"), d); }
    loadFromCloud();
  };

  window.loadFromCloud();
</script>

<script>
    function prochainDialogue() {
        if(window.dialogues.length === 0) return alert("Initialise les dialogues d'abord !");
        window.currentIdx = Math.floor(Math.random() * window.dialogues.length);
        const d = window.dialogues[window.currentIdx];
        
        const botB = document.getElementById('botBubble');
        botB.innerText = d.question;
        botB.className = "bubble bot " + (d.lang === 'he-IL' ? "rtl" : "");
        
        document.getElementById('userBubble').style.display = "none";
        document.getElementById('scenarioTag').innerText = d.scenario;
        
        // Parle automatiquement
        rejouerQuestion();
    }

    function rejouerQuestion() {
        const d = window.dialogues[window.currentIdx];
        const msg = new SpeechSynthesisUtterance(d.question);
        msg.lang = d.lang;
        window.speechSynthesis.speak(msg);
    }

    function afficherAide() {
        const d = window.dialogues[window.currentIdx];
        alert("Aide : " + d.hint);
    }

    function ecouterUtilisateur() {
        const d = window.dialogues[window.currentIdx];
        const rec = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
        rec.lang = d.lang;
        rec.start();
        
        document.getElementById('status').innerText = "Je t'Ã©coute...";
        
        rec.onresult = (e) => {
            const dit = e.results[0][0].transcript.toLowerCase();
            const userB = document.getElementById('userBubble');
            userB.innerText = dit;
            userB.style.display = "block";
            userB.className = "bubble user " + (d.lang === 'he-IL' ? "rtl" : "");

            if(dit.includes(d.answer.toLowerCase())) {
                document.getElementById('status').innerText = "âœ… TrÃ¨s bien !";
                const bravo = new SpeechSynthesisUtterance("Excellent");
                bravo.lang = "fr-FR";
                window.speechSynthesis.speak(bravo);
            } else {
                document.getElementById('status').innerText = "âŒ Essaye encore...";
            }
        };
    }
</script>

</body>
</html>
