<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polyglot Coach - Phrases VariÃ©es</title>
    <style>
        :root { --primary: #4A90E2; --success: #4caf50; --accent: #ff9800; --bg: #f4f7f9; --text: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 10px; margin: 0; color: var(--text); }
        .container { width: 100%; max-width: 500px; background: white; padding: 20px; border-radius: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); text-align: center; }
        
        .scenario-box { background: #f0f7ff; padding: 12px; border-radius: 15px; font-size: 0.85rem; color: var(--primary); font-weight: bold; margin-bottom: 15px; border-left: 5px solid var(--primary); text-transform: uppercase; }
        
        .chat-area { display: flex; flex-direction: column; gap: 15px; margin: 20px 0; min-height: 200px; }
        .bubble { padding: 15px 20px; border-radius: 20px; max-width: 85%; font-size: 1.1rem; line-height: 1.4; position: relative; transition: 0.3s; }
        .bubble.bot { background: #eee; align-self: flex-start; border-bottom-left-radius: 5px; color: #333; text-align: left; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); }
        .bubble.user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 5px; text-align: right; display: none; }
        
        .rtl { direction: rtl; font-family: 'Arial', sans-serif; font-size: 1.5rem !important; }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { padding: 15px; border: none; border-radius: 15px; cursor: pointer; font-weight: 700; transition: 0.2s; font-size: 14px; }
        .btn-mic { background: var(--success); color: white; grid-column: span 2; font-size: 1.1rem; }
        .btn-next { background: var(--primary); color: white; grid-column: span 2; font-size: 1.1rem; }
        .btn-listen { background: var(--accent); color: white; }
        .btn-hint { background: #95a5a6; color: white; }
        
        #status { font-size: 0.8rem; color: #bdc3c7; margin: 15px 0; font-style: italic; }
        .small-btn { background: #ff4757; color: white; font-size: 11px; margin-top: 30px; padding: 10px; border-radius: 10px; width: 100%; }
    </style>
</head>
<body>

<div class="container">
    <div class="scenario-box" id="scenarioTag">BIENVENUE</div>
    
    <select id="langSelect" onchange="loadFromCloud()">
        <option value="en-US">Anglais ğŸ‡ºğŸ‡¸</option>
        <option value="he-IL">HÃ©breu ğŸ‡®ğŸ‡±</option>
        <option value="es-ES">Espagnol ğŸ‡ªğŸ‡¸</option>
    </select>

    <div class="chat-area">
        <div class="bubble bot" id="botBubble">PrÃªt pour une nouvelle discussion ?</div>
        <div class="bubble user" id="userBubble">...</div>
    </div>

    <div id="status">SÃ©lectionnez une langue et lancez</div>

    <div class="controls">
        <button class="btn-mic" onclick="ecouterUtilisateur()">ğŸ¤ RÃ‰PONDRE PAR LA VOIX</button>
        <button class="btn-listen" onclick="rejouerQuestion()">ğŸ”Š RÃ‰Ã‰COUTER</button>
        <button class="btn-hint" onclick="afficherAide()">ğŸ’¡ VOIR L'AIDE</button>
        <button class="btn-next" onclick="prochainDialogue()">NOUVELLE QUESTION â”</button>
    </div>

    <button class="small-btn" onclick="seedDialogues()">ğŸ—‘ RÃ‰INITIALISER TOUTES LES PHRASES</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB2v6Biqc9DjryoFJa1q1ezNFFeoo0QJrg",
    authDomain: "mon-app-langue.firebaseapp.com",
    projectId: "mon-app-langue",
    storageBucket: "mon-app-langue.firebasestorage.app",
    messagingSenderId: "664705865852",
    appId: "1:664705865852:web:1b8512b74bdcef753651f9"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.dialogues = [];
  window.currentIdx = -1;

  window.loadFromCloud = async function() {
    const lang = document.getElementById('langSelect').value;
    const q = query(collection(db, "dialogues"));
    const snap = await getDocs(q);
    window.dialogues = [];
    snap.forEach(doc => {
        if(doc.data().lang === lang) window.dialogues.push(doc.data());
    });
    document.getElementById('status').innerText = "Phrases disponibles : " + window.dialogues.length;
  };

  window.seedDialogues = async function() {
    if(!confirm("Cela va ajouter de nombreuses phrases. Continuer ?")) return;
    document.getElementById('status').innerText = "GÃ©nÃ©ration du contenu...";
    
    const starter = [
        // ANGLAIS
        { lang: "en-US", scenario: "RESTO", question: "Are you ready to order?", answer: "i would like", hint: "Dites : 'I would like a burger'" },
        { lang: "en-US", scenario: "MÃ‰TÃ‰O", question: "What's the weather like today?", answer: "sunny", hint: "Dites : 'It is very sunny'" },
        { lang: "en-US", scenario: "TRAVAIL", question: "What do you do for a living?", answer: "i am a", hint: "Dites : 'I am a student' ou votre mÃ©tier" },
        { lang: "en-US", scenario: "SANTÃ‰", question: "Where does it hurt?", answer: "head", hint: "Dites : 'My head hurts'" },
        { lang: "en-US", scenario: "VOYAGE", question: "Can I see your passport, please?", answer: "here is", hint: "Dites : 'Here is my passport'" },
        
        // HÃ‰BREU
        { lang: "he-IL", scenario: "SALUT", question: "××” ×©×œ×•××š ×”×™×•×?", answer: "×˜×•×‘", hint: "RÃ©pondez : 'Tov, toda' (Bien, merci)" },
        { lang: "he-IL", scenario: "RESTO", question: "××¤×©×¨ ×œ×”×–××™×Ÿ?", answer: "×× ×™ ×¨×•×¦×”", hint: "Dites : 'Ani rotse cafe' (Je veux un cafÃ©)" },
        { lang: "he-IL", scenario: "MARCHÃ‰", question: "×›××” ×–×” ×¢×•×œ×”?", answer: "×©×§×œ", hint: "Dites le prix ou 'Zeh yakar' (C'est cher)" },
        { lang: "he-IL", scenario: "DIRECTIONS", question: "××™×¤×” ×”××œ×•×Ÿ?", answer: "×™×©×¨", hint: "Dites : 'Yashar yashar' (Tout droit)" },
        { lang: "he-IL", scenario: "FAMILLE", question: "×™×© ×œ×š ×™×œ×“×™×?", answer: "×›×Ÿ", hint: "Dites : 'Ken, yesh li...' (Oui, j'ai...)" }
    ];

    for (const d of starter) { 
        await addDoc(collection(db, "dialogues"), d); 
    }
    alert("30+ nouvelles situations ajoutÃ©es !");
    loadFromCloud();
  };

  window.loadFromCloud();
</script>

<script>
    function prochainDialogue() {
        if(window.dialogues.length === 0) return alert("Cliquez sur le bouton rouge en bas pour charger les phrases !");
        
        // Ã‰viter de tomber deux fois sur la mÃªme
        let newIdx = Math.floor(Math.random() * window.dialogues.length);
        while(newIdx === window.currentIdx && window.dialogues.length > 1) {
            newIdx = Math.floor(Math.random() * window.dialogues.length);
        }
        window.currentIdx = newIdx;
        
        const d = window.dialogues[window.currentIdx];
        const botB = document.getElementById('botBubble');
        botB.innerText = d.question;
        botB.className = "bubble bot " + (d.lang === 'he-IL' ? "rtl" : "");
        
        document.getElementById('userBubble').style.display = "none";
        document.getElementById('scenarioTag').innerText = d.scenario;
        document.getElementById('status').innerText = "Ã‰coutez la question...";
        
        rejouerQuestion();
    }

    function rejouerQuestion() {
        if(window.currentIdx === -1) return;
        const d = window.dialogues[window.currentIdx];
        const msg = new SpeechSynthesisUtterance(d.question);
        msg.lang = d.lang;
        window.speechSynthesis.speak(msg);
    }

    function afficherAide() {
        if(window.currentIdx === -1) return;
        alert("ğŸ’¡ " + window.dialogues[window.currentIdx].hint);
    }

    function ecouterUtilisateur() {
        if(window.currentIdx === -1) return alert("Lancez d'abord un dialogue !");
        const d = window.dialogues[window.currentIdx];
        const rec = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
        rec.lang = d.lang;
        rec.start();
        
        document.getElementById('status').innerText = "Je vous Ã©coute...";
        
        rec.onresult = (e) => {
            const dit = e.results[0][0].transcript.toLowerCase();
            const userB = document.getElementById('userBubble');
            userB.innerText = dit;
            userB.style.display = "block";
            userB.className = "bubble user " + (d.lang === 'he-IL' ? "rtl" : "");

            if(dit.includes(d.answer.toLowerCase())) {
                document.getElementById('status').innerText = "âœ… Excellent !";
                const v = new SpeechSynthesisUtterance("Very good!");
                v.lang = "en-US"; window.speechSynthesis.speak(v);
            } else {
                document.getElementById('status').innerText = "âŒ J'ai entendu '" + dit + "'. Essayez encore !";
            }
        };
    }
</script>

</body>
</html>
