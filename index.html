<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polyglot Coach v2</title>
    <style>
        :root { --primary: #4A90E2; --success: #4caf50; --accent: #ff9800; --bg: #f4f7f9; --text: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 15px; margin: 0; color: var(--text); }
        .container { width: 100%; max-width: 500px; background: white; padding: 25px; border-radius: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); text-align: center; }
        
        .header { margin-bottom: 20px; }
        .scenario-box { background: #e8f0fe; padding: 10px; border-radius: 12px; font-size: 0.9rem; color: var(--primary); font-weight: bold; margin-bottom: 15px; min-height: 20px; }
        
        select, input { width: 100%; padding: 14px; margin: 5px 0; border: 2px solid #eee; border-radius: 15px; box-sizing: border-box; font-size: 16px; outline: none; }
        
        /* Bulle de Discussion */
        .card { 
            min-height: 180px; 
            background: #fff; 
            border: 3px solid var(--primary);
            border-radius: 30px 30px 5px 30px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 20px 0; 
            cursor: pointer; 
            padding: 25px;
            transition: 0.3s;
        }
        
        #wordDisplay { font-size: 1.4rem; font-weight: 500; line-height: 1.4; }
        #wordDisplay.rtl { font-size: 1.9rem; direction: rtl; }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        button { padding: 15px; border: none; border-radius: 15px; cursor: pointer; font-weight: 700; font-size: 15px; transition: 0.2s; }
        button:active { transform: scale(0.95); }
        
        .btn-add { background: #2c3e50; color: white; width: 100%; margin-top: 10px; }
        .btn-speak { background: var(--accent); color: white; }
        .btn-mic { background: var(--success); color: white; }
        .btn-next { background: var(--primary); color: white; grid-column: span 2; margin-top: 10px; font-size: 18px; }
        
        #status { font-size: 0.8rem; color: #95a5a6; margin-top: 15px; }
        .small-btn { background: none; color: #bdc3c7; font-size: 10px; margin-top: 20px; border: 1px solid #eee; padding: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ—£ Coach de Discussion</h1>
        <div class="scenario-box" id="scenarioDisplay">PrÃªt Ã  pratiquer ?</div>
    </div>
    
    <select id="langSelect" onchange="loadFromCloud()">
        <option value="en-US">Anglais ğŸ‡ºğŸ‡¸</option>
        <option value="he-IL">HÃ©breu ğŸ‡®ğŸ‡±</option>
        <option value="es-ES">Espagnol ğŸ‡ªğŸ‡¸</option>
    </select>

    <div class="card" onclick="toggleCard()">
        <div id="wordDisplay">Clique sur "DÃ©fi Suivant" pour commencer !</div>
    </div>

    <div class="btn-group">
        <button class="btn-speak" onclick="prononcer()">ğŸ”Š Ã‰couter</button>
        <button class="btn-mic" onclick="testerVoix()">ğŸ¤ RÃ©pondre</button>
        <button class="btn-next" onclick="nextRandom()">DÃ©fi Suivant â”</button>
    </div>

    <input type="text" id="wordInput" placeholder="Ajouter une phrase perso...">
    <button class="btn-add" onclick="searchAndAdd()">â• Ajouter au Cloud</button>

    <p id="status">Chargement du cloud...</p>
    <button class="small-btn" onclick="seedDatabase()">RÃ©initialiser les phrases types</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB2v6Biqc9DjryoFJa1q1ezNFFeoo0QJrg",
    authDomain: "mon-app-langue.firebaseapp.com",
    projectId: "mon-app-langue",
    storageBucket: "mon-app-langue.firebasestorage.app",
    messagingSenderId: "664705865852",
    appId: "1:664705865852:web:1b8512b74bdcef753651f9"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.myWords = { "en-US": [], "he-IL": [], "es-ES": [] };
  window.currentWord = null;

  window.loadFromCloud = async function() {
    try {
        const q = query(collection(db, "dictionnaire"), orderBy("createdAt", "desc"));
        const querySnapshot = await getDocs(q);
        window.myWords = { "en-US": [], "he-IL": [], "es-ES": [] };
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            window.myWords[data.lang].push(data);
        });
        document.getElementById('status').innerText = "Cloud synchronisÃ© âœ…";
    } catch(e) { console.error(e); }
  };

  window.searchAndAdd = async function() {
    const val = document.getElementById('wordInput').value;
    const lang = document.getElementById('langSelect').value;
    if(!val) return;
    try {
        const res = await fetch(`https://api.mymemory.translated.net/get?q=${val}&langpair=${lang.split('-')[0]}|fr`);
        const data = await res.json();
        await addDoc(collection(db, "dictionnaire"), {
            source: val,
            target: data.responseData.translatedText,
            lang: lang,
            scenario: "Phrase personnelle",
            createdAt: new Date()
        });
        document.getElementById('wordInput').value = "";
        loadFromCloud();
    } catch (e) { console.error(e); }
  };

  window.seedDatabase = async function() {
    const data = [
        { lang: "en-US", source: "I would like to book a table for two.", target: "Je voudrais rÃ©server une table pour deux.", scenario: "AU RESTAURANT" },
        { lang: "en-US", source: "Could you tell me where the nearest station is?", target: "Pourriez-vous me dire oÃ¹ se trouve la station la plus proche ?", scenario: "DANS LA RUE" },
        { lang: "he-IL", source: "×›××” ×–×” ×¢×•×œ×”?", target: "Combien Ã§a coÃ»te ?", scenario: "AU MARCHÃ‰" },
        { lang: "he-IL", source: "××¤×©×¨ ×œ×§×‘×œ ×—×©×‘×•×Ÿ ×‘×‘×§×©×”?", target: "Puis-je avoir l'addition s'il vous plaÃ®t ?", scenario: "AU RESTAURANT" },
        { lang: "es-ES", source: "Hola, Â¿cÃ³mo te llamas?", target: "Bonjour, comment t'appelles-tu ?", scenario: "RENCONTRE" }
    ];
    for (const p of data) { await addDoc(collection(db, "dictionnaire"), { ...p, createdAt: new Date() }); }
    loadFromCloud();
  };

  window.loadFromCloud();
</script>

<script>
    let isFlipped = false;

    function nextRandom() {
        const lang = document.getElementById('langSelect').value;
        const list = window.myWords[lang];
        if(!list || list.length === 0) return alert("Ajoute des phrases pour cette langue !");
        
        window.currentWord = list[Math.floor(Math.random() * list.length)];
        isFlipped = true; // On commence par montrer la traduction (le dÃ©fi)
        updateUI();
    }

    function toggleCard() {
        if(!window.currentWord) return;
        isFlipped = !isFlipped;
        updateUI();
    }

    function updateUI() {
        const display = document.getElementById('wordDisplay');
        const scn = document.getElementById('scenarioDisplay');
        
        display.innerText = isFlipped ? window.currentWord.target : window.currentWord.source;
        scn.innerText = window.currentWord.scenario || "PRATIQUE LIBRE";
        
        if(!isFlipped && window.currentWord.lang === 'he-IL') display.classList.add('rtl');
        else display.classList.remove('rtl');
    }

    function prononcer() {
        if(!window.currentWord) return;
        const msg = new SpeechSynthesisUtterance(window.currentWord.source);
        msg.lang = window.currentWord.lang;
        window.speechSynthesis.speak(msg);
    }

    function testerVoix() {
        if(!window.currentWord) return;
        const rec = new (window.webkitSpeechRecognition || window.Recognition)();
        rec.lang = window.currentWord.lang;
        rec.start();
        rec.onresult = (e) => {
            const dit = e.results[0][0].transcript.toLowerCase();
            const cible = window.currentWord.source.toLowerCase();
            if(dit.includes(cible.replace(/[?.!,]/g, ""))) alert("âœ… Bravo !");
            else alert("âŒ J'ai entendu : " + dit);
        };
    }
</script>

</body>
</html>
